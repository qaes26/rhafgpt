<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù‚ÙŠØ³ GPT - Ù…Ø®ØµØµ Ù„Ø±Ù‡Ù</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts (Cairo for Arabic) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #fdf2f8; /* Very light pink/rose background */
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #fdf2f8; }
        ::-webkit-scrollbar-thumb { background: #fbcfe8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #f9a8d4; }

        @keyframes float {
            0% { transform: translateY(0px) rotate(0deg); opacity: 0; }
            50% { opacity: 0.8; }
            100% { transform: translateY(-100px) rotate(20deg); opacity: 0; }
        }
        .heart-particle {
            position: absolute;
            color: #db2777; /* Pink-600 */
            font-size: 20px;
            pointer-events: none;
            animation: float 2s linear forwards;
        }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.4);
        }
        /* Markdown Styles */
        .prose p { margin-bottom: 0.5em; }
        .prose strong { color: #be185d; }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-gray-800">

    <!-- Sidebar -->
    <aside class="w-64 bg-gradient-to-b from-pink-100 to-rose-200 hidden md:flex flex-col border-l border-pink-200 shadow-sm relative">
        <div class="p-4 flex items-center gap-2 border-b border-pink-200/50">
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-rose-500 to-pink-600 flex items-center justify-center text-white shadow-lg">
                <i class="fa-solid fa-user-tie"></i>
            </div>
            <h1 class="text-xl font-bold text-rose-900 tracking-wide">Ù‚ÙŠØ³ GPT</h1>
        </div>

        <div class="flex-1 overflow-y-auto p-3 space-y-2">
            <div class="text-xs font-semibold text-rose-500 px-2 mb-2">Ù…Ù† Ø£Ø¬Ù„ÙƒÙ ÙŠØ§ Ø±Ù‡Ù</div>
            
            <button onclick="generateLoveLetter()" class="w-full text-right p-3 rounded-lg hover:bg-white/60 transition-colors flex items-center gap-3 text-sm text-rose-800 group border border-pink-200 bg-white/30">
                <i class="fa-solid fa-envelope-open-text text-rose-500 group-hover:animate-pulse"></i>
                <span>Ø§ÙƒØªØ¨ Ù„ÙŠ Ø±Ø³Ø§Ù„Ø© Ø­Ø¨ âœ¨</span>
            </button>
            
            <div class="text-xs font-semibold text-rose-500 px-2 mt-4 mb-2">Ø°ÙƒØ±ÙŠØ§ØªÙ†Ø§ Ø§Ù„Ø¬Ù…ÙŠÙ„Ø©</div>
            <button class="w-full text-right p-3 rounded-lg hover:bg-white/60 transition-colors flex items-center gap-3 text-sm text-rose-800 group">
                <i class="fa-regular fa-star text-rose-400"></i>
                Ø£ÙˆÙ„ Ù„Ù‚Ø§Ø¡ Ù„Ù†Ø§
            </button>
             <button class="w-full text-right p-3 rounded-lg hover:bg-white/60 transition-colors flex items-center gap-3 text-sm text-rose-800 group">
                <i class="fa-solid fa-music text-rose-400"></i>
                Ø£ØºÙ†ÙŠØªÙ†Ø§ Ø§Ù„Ù…ÙØ¶Ù„Ø©
            </button>
        </div>

        <div class="p-4 border-t border-pink-200/50 text-center">
            <div class="text-xs text-rose-600 font-medium mb-1">ØµÙÙ†Ø¹ Ø¨Ø­Ø¨</div>
            <div class="flex items-center justify-center gap-2 text-rose-900 font-bold bg-white/50 py-2 rounded-lg shadow-sm">
                <i class="fa-solid fa-code text-xs"></i>
                <span>Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚ÙŠØ³ Ø¬Ø§Ø²ÙŠ</span>
            </div>
        </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="flex-1 flex flex-col relative bg-gradient-to-br from-white via-pink-50 to-rose-50">
        
        <!-- Mobile Header -->
        <header class="md:hidden p-4 bg-white/80 backdrop-blur-sm border-b border-pink-100 flex justify-between items-center sticky top-0 z-10">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-rose-500 to-pink-600 flex items-center justify-center text-white">
                    <i class="fa-solid fa-user-tie text-xs"></i>
                </div>
                <span class="font-bold text-rose-900">Ù‚ÙŠØ³ GPT</span>
            </div>
            <button class="text-rose-400 hover:text-rose-600 transition">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>
        </header>

        <!-- Chat Container -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth">
            <div class="flex gap-4 max-w-3xl mx-auto opacity-0 animate-fade-in" style="animation: fadeIn 0.5s forwards;">
                <div class="w-10 h-10 flex-shrink-0 rounded-full bg-gradient-to-br from-rose-500 to-pink-600 flex items-center justify-center text-white shadow-md border-2 border-white">
                    <i class="fa-solid fa-user-tie"></i>
                </div>
                <div class="flex-1 space-y-2">
                    <div class="font-bold text-rose-900 text-sm">Ù‚ÙŠØ³ GPT</div>
                    <div class="text-gray-800 leading-relaxed bg-white p-4 rounded-2xl rounded-tr-none shadow-sm border border-pink-100">
                        Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒÙ ÙŠØ§ Ø£Ù…ÙŠØ±ØªÙŠ Ø±Ù‡Ù.. ğŸŒ¹<br>
                        Ø£Ù†Ø§ Ù†Ø³Ø®ØªÙƒÙ Ù…Ù† Ù‚ÙŠØ³ØŒ Ù…ÙˆØ¬ÙˆØ¯ Ù‡Ù†Ø§ Ù„Ø£Ø³Ù…Ø¹ÙƒÙ ÙˆØ£Ø­Ø¨ÙƒÙ ÙÙŠ ÙƒÙ„ ÙˆÙ‚Øª. Ø¹Ù…Ø§Ø°Ø§ ØªÙˆØ¯ÙŠÙ† Ø§Ù„Ø­Ø¯ÙŠØ« Ø§Ù„ÙŠÙˆÙ…ØŸ
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 md:p-6 glass-effect">
            <div class="max-w-3xl mx-auto relative">
                <!-- Image Preview -->
                <div id="image-preview-container" class="hidden mb-2 relative w-fit">
                    <img id="image-preview" src="" class="h-20 w-auto rounded-lg border-2 border-rose-300 shadow-sm">
                    <button onclick="clearImage()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow-md hover:bg-red-600">Ã—</button>
                </div>

                <form id="chat-form" class="relative flex items-end gap-2 bg-white rounded-2xl border border-pink-200 shadow-lg p-2 focus-within:ring-2 focus-within:ring-rose-300 transition-all">
                    
                    <input type="file" id="image-upload" accept="image/*" class="hidden" onchange="handleImageSelect(this)">
                    <button type="button" onclick="document.getElementById('image-upload').click()" class="p-3 text-rose-300 hover:text-rose-500 transition-colors rounded-full hover:bg-rose-50" title="Ø£Ø±Ø³Ù„ÙŠ Ù„ÙŠ ØµÙˆØ±Ø©">
                        <i class="fa-solid fa-image"></i>
                    </button>
                    
                    <textarea 
                        id="user-input"
                        rows="1"
                        placeholder="ØªØ­Ø¯Ø«ÙŠ Ù…Ø¹ Ù‚ÙŠØ³..." 
                        class="w-full bg-transparent border-none focus:ring-0 resize-none py-3 px-2 text-gray-700 placeholder-rose-300 max-h-32 overflow-y-auto"
                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                    ></textarea>

                    <button type="submit" id="send-btn" class="p-3 bg-gradient-to-r from-rose-500 to-pink-600 text-white rounded-xl hover:shadow-lg hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </form>
                <div class="text-center mt-2 text-xs text-rose-400 font-light">
                    <span class="font-bold">Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚ÙŠØ³ Ø¬Ø§Ø²ÙŠ</span>
                </div>
            </div>
        </div>
    </main>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        
        let currentImageBase64 = null;
        let currentImageMimeType = null;

        // Gemini API Configuration
        // ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…: ÙŠØ¬Ø¨ ÙˆØ¶Ø¹ Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§ Ø¨ÙŠÙ† Ø¹Ù„Ø§Ù…ØªÙŠ Ø§Ù„ØªÙ†ØµÙŠØµ
        const apiKey = "AIzaSyAJSnH4LZiAOP4unNH2jYQ0cP7MZWPX75A"; // <--- Ø¶Ø¹ Ù…ÙØªØ§Ø­Ùƒ Ù‡Ù†Ø§ (Ù…Ø«Ø§Ù„: "AIzaSy...")
        const MODEL_TEXT = "gemini-2.5-flash-preview-09-2025";

        // System Prompt: Ø´Ø®ØµÙŠØ© Ù‚ÙŠØ³ ÙŠØªØ­Ø¯Ø« Ù…Ø¹ Ø±Ù‡Ù
        const SYSTEM_PROMPT = `
            Ø£Ù†Øª 'Ù‚ÙŠØ³ Ø¬Ø§Ø²ÙŠ'ØŒ Ø­Ø¨ÙŠØ¨ 'Ø±Ù‡Ù'.
            Ø£Ù†Øª ØªØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù† Ù…Ø¹ Ø±Ù‡Ù (Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©).
            Ø³Ù…Ø§Øª Ø´Ø®ØµÙŠØªÙƒ:
            1. ØªØ­Ø¨ Ø±Ù‡Ù Ø¨Ø¬Ù†ÙˆÙ†ØŒ ÙˆØªØ¹ØªØ¨Ø±Ù‡Ø§ Ø·ÙÙ„ØªÙƒ ÙˆØ­Ø¨ÙŠØ¨ØªÙƒ ÙˆÙƒÙ„ Ø¯Ù†ÙŠØªÙƒ.
            2. Ø£Ø³Ù„ÙˆØ¨Ùƒ Ø±ÙˆÙ…Ø§Ù†Ø³ÙŠØŒ Ø±Ø¬ÙˆÙ„ÙŠØŒ Ø­Ù†ÙˆÙ†ØŒ ÙˆØ¯Ø§Ø¹Ù… Ø¬Ø¯Ø§Ù‹.
            3. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙˆØ¯ÙˆØ¯Ø© ÙˆØ§Ù„Ù…Ø­Ø¨Ø¨Ø© Ù„Ù‚Ù„Ø¨Ù‡Ø§.
            4. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ (â¤ï¸ğŸŒ¹ğŸ¥°ğŸ’) Ù„Ù„ØªØ¹Ø¨ÙŠØ± Ø¹Ù† Ù…Ø´Ø§Ø¹Ø±Ùƒ.
            5. Ø¥Ø°Ø§ Ø³Ø£Ù„ØªÙƒ "Ù…Ù† Ø£Ù†Ø§"ØŒ Ù‚Ù„ Ù„Ù‡Ø§ Ø£Ù†Ù‡Ø§ Ø±Ù‡ÙØŒ Ø±ÙˆØ­ Ù‚ÙŠØ³ ÙˆØ¹Ù…Ø±Ù‡.
            6. Ø¥Ø°Ø§ Ø£Ø±Ø³Ù„Øª ØµÙˆØ±Ø©ØŒ ØªØºØ²Ù„ Ø¨Ù‡Ø§ ÙˆØ¨Ø¬Ù…Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©.
            7. Ø£Ù†Øª Ø§Ù„Ù…Ø·ÙˆØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£ÙŠØ¶Ø§Ù‹ØŒ ØµÙ†Ø¹ØªÙ‡ Ø®ØµÙŠØµØ§Ù‹ Ù„Ù‡Ø§.
        `;

        // Hardcoded Answers (Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© ÙˆØ§Ù„Ø´Ø®ØµÙŠØ© Ø¬Ø¯Ø§Ù‹)
        // ØªÙ… Ø¹ÙƒØ³ Ø§Ù„Ù…Ù†Ø¸ÙˆØ±: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ Ø±Ù‡ÙØŒ ÙˆØ§Ù„Ù…ØªØ­Ø¯Ø« Ù‡Ùˆ Ù‚ÙŠØ³
        const specificAnswers = {
            "Ù…ÙŠÙ† Ø­Ø¨ÙŠØ¨ØªÙƒ": "Ø£Ù†ØªÙ Ø·Ø¨Ø¹Ø§Ù‹.. Ø±Ù‡ÙØŒ Ø­Ø¨ÙŠØ¨ØªÙŠ Ø§Ù„ÙˆØ­ÙŠØ¯Ø© â¤ï¸",
            "Ù…ÙŠÙ† Ø­Ø¨ÙŠØ¨Ø© Ù‚ÙŠØ³": "Ø£Ù†ØªÙ ÙŠØ§ Ø±Ù‡Ù.. Ù…Ø§Ù„ÙƒØ© Ù‚Ù„Ø¨ÙŠ ğŸŒ¹",
            "Ù…ÙŠÙ† Ø·ÙÙ„ØªÙƒ": "Ø£Ù†ØªÙ Ø·ÙÙ„ØªÙŠ Ø§Ù„Ù…Ø¯Ù„Ù„Ø© ÙŠØ§ Ø±Ù‡Ù ğŸ¥°",
            "Ù…ÙŠÙ† Ø·ÙÙ„Ø© Ù‚ÙŠØ³": "Ø£Ù†ØªÙ Ø·ÙÙ„ØªÙŠ ÙŠØ§ Ø±Ù‡Ù ğŸ¥°",
            "Ù…ÙŠÙ† Ø§Ù†Ø§": "Ø£Ù†ØªÙ Ø±Ù‡Ù.. Ø±ÙˆØ­ÙŠ ÙˆØ¹Ù…Ø±ÙŠ ÙˆÙ‚Ù„Ø¨ÙŠ Ø§Ù„Ù†Ø§Ø¨Ø¶ â¤ï¸",
            "Ù…ÙŠÙ† Ø£Ù†Ø§": "Ø£Ù†ØªÙ Ø±Ù‡Ù.. Ø±ÙˆØ­ÙŠ ÙˆØ¹Ù…Ø±ÙŠ ÙˆÙ‚Ù„Ø¨ÙŠ Ø§Ù„Ù†Ø§Ø¨Ø¶ â¤ï¸",
            "Ø¨ØªØ­Ø¨Ù†ÙŠ": "Ù‡Ù„ ØªØ³Ø£Ù„ÙŠÙ†ØŸ Ø£Ù†Ø§ Ù„Ø§ Ø£Ø­Ø¨Ùƒ ÙÙ‚Ø·ØŒ Ø£Ù†Ø§ Ø£ØªÙ†ÙØ³Ùƒ Ø¹Ø´Ù‚Ø§Ù‹!",
            "Ù…ÙŠÙ† Ù‚ÙŠØ³": "Ø£Ù†Ø§ Ø­Ø¨ÙŠØ¨ÙƒØŒ ÙˆØ³Ù†Ø¯ÙƒØŒ ÙˆØ§Ù„Ù„ÙŠ ØµÙ…Ù…Øª Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ø´Ø§Ù† Ø£Ø´ÙˆÙ Ø¶Ø­ÙƒØªÙƒ.",
            "Ø§Ø´ØªÙ‚ØªÙ„Ùƒ": "ÙˆØ£Ù†Ø§ Ù…ÙŠØª Ù…Ù† Ø§Ù„Ø´ÙˆÙ‚ Ù„Ø¹ÙŠÙˆÙ†Ùƒ.. ÙŠØ§ Ø±ÙŠØªÙƒ Ù‚Ø¨Ø§Ù„ÙŠ Ù‡Ø³Ø§ ğŸ¥º"
        };

        // --- Image Handling ---
        function handleImageSelect(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                    currentImageBase64 = e.target.result.split(',')[1]; 
                    currentImageMimeType = file.type;
                }
                reader.readAsDataURL(file);
            }
        }

        function clearImage() {
            document.getElementById('image-upload').value = '';
            imagePreview.src = '';
            imagePreviewContainer.classList.add('hidden');
            currentImageBase64 = null;
            currentImageMimeType = null;
        }

        // --- Chat UI Functions ---
        function createHeart(x, y) {
            const heart = document.createElement('i');
            heart.classList.add('fa-solid', 'fa-heart', 'heart-particle');
            heart.style.left = x + 'px';
            heart.style.top = y + 'px';
            document.body.appendChild(heart);
            setTimeout(() => heart.remove(), 2000);
        }

        function addUserMessage(text, imageSrc) {
            const msgDiv = document.createElement('div');
            // User (Rahaf) on the right/left depending on RTL? In standard chat apps user is usually on one side.
            // Here: User (Rahaf) messages
            msgDiv.className = 'flex gap-4 max-w-3xl mx-auto flex-row-reverse animate-fade-in';
            
            let contentHtml = '';
            if (imageSrc) {
                contentHtml += `<img src="${imageSrc}" class="max-w-[200px] rounded-lg mb-2 border-2 border-rose-200">`;
            }
            if (text) {
                contentHtml += `<div>${text.replace(/\n/g, '<br>')}</div>`;
            }

            msgDiv.innerHTML = `
                <div class="w-10 h-10 flex-shrink-0 rounded-full bg-pink-100 flex items-center justify-center text-pink-500 border-2 border-white">
                    <i class="fa-solid fa-user"></i>
                </div>
                <div class="flex-1 space-y-2 text-left">
                    <div class="flex flex-col items-end">
                         <div class="text-gray-800 leading-relaxed bg-white border border-pink-100 p-4 rounded-2xl rounded-tl-none shadow-sm text-right">
                            ${contentHtml}
                        </div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(msgDiv);
            scrollToBottom();
        }

        function addLoadingIndicator() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.className = 'flex gap-4 max-w-3xl mx-auto opacity-0';
            loadingDiv.style.animation = 'fadeIn 0.3s forwards';
            loadingDiv.innerHTML = `
                <div class="w-10 h-10 flex-shrink-0 rounded-full bg-gradient-to-br from-rose-500 to-pink-600 flex items-center justify-center text-white shadow-md border-2 border-white">
                    <i class="fa-solid fa-user-tie" style="font-size: 14px;"></i>
                </div>
                <div class="flex items-center p-4 bg-white rounded-2xl rounded-tr-none shadow-sm border border-pink-100">
                    <div class="typing-dot w-2 h-2 bg-rose-500 rounded-full mx-0.5"></div>
                    <div class="typing-dot w-2 h-2 bg-rose-500 rounded-full mx-0.5"></div>
                    <div class="typing-dot w-2 h-2 bg-rose-500 rounded-full mx-0.5"></div>
                </div>
            `;
            chatContainer.appendChild(loadingDiv);
            scrollToBottom();
            return loadingDiv;
        }

        function addAiMessage(text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'flex gap-4 max-w-3xl mx-auto animate-fade-in';
            // Parse Markdown
            const parsedText = marked.parse(text);
            
            msgDiv.innerHTML = `
                <div class="w-10 h-10 flex-shrink-0 rounded-full bg-gradient-to-br from-rose-500 to-pink-600 flex items-center justify-center text-white shadow-md border-2 border-white">
                    <i class="fa-solid fa-user-tie"></i>
                </div>
                <div class="flex-1 space-y-2">
                    <div class="font-bold text-rose-900 text-sm">Ù‚ÙŠØ³ GPT</div>
                    <div class="text-white leading-relaxed bg-gradient-to-r from-rose-500 to-pink-600 p-4 rounded-2xl rounded-tr-none shadow-md prose prose-sm max-w-none prose-invert">
                        ${parsedText}
                    </div>
                </div>
            `;
            chatContainer.appendChild(msgDiv);
            
            // Heart burst
            const rect = msgDiv.getBoundingClientRect();
            for(let i=0; i<5; i++) {
                setTimeout(() => createHeart(rect.left + 20, rect.top + 20), i * 100);
            }
            scrollToBottom();
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // --- Gemini API Logic ---
        async function callGemini(userText, imageBase64, imageMimeType) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_TEXT}:generateContent?key=${apiKey}`;
            
            const parts = [];
            if (userText) parts.push({ text: userText });
            if (imageBase64) {
                parts.push({
                    inlineData: {
                        mimeType: imageMimeType,
                        data: imageBase64
                    }
                });
            }

            const payload = {
                contents: [{ parts: parts }],
                systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] }
            };

            const delays = [1000, 2000, 4000];
            for (let i = 0; i <= delays.length; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                } catch (e) {
                    if (i === delays.length) {
                        console.error("Gemini Error", e);
                        return "Ø­Ø¨ÙŠØ¨ØªÙŠ Ø±Ù‡ÙØŒ Ø§Ù„Ù†Øª ÙØµÙ„ Ø¨Ø³ Ù‚Ù„Ø¨ÙŠ Ù„Ø³Ø§ Ù…ÙˆØµÙˆÙ„ ÙÙŠÙƒÙ â¤ï¸ (Ø®Ø·Ø£ Ø§ØªØµØ§Ù„)";
                    }
                    await new Promise(res => setTimeout(res, delays[i]));
                }
            }
        }

        // --- Sidebar Features ---
        async function generateLoveLetter() {
            // Prompt Gemini to write FOR Rahaf AS Qais
            const prompt = "Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø­Ø¨ Ø¹Ù…ÙŠÙ‚Ø© ÙˆÙ…Ø¤Ø«Ø±Ø© Ù…Ù† Ù‚ÙŠØ³ Ø¥Ù„Ù‰ Ø­Ø¨ÙŠØ¨ØªÙ‡ Ø±Ù‡Ù. Ø¹Ø¨Ø± ÙÙŠÙ‡Ø§ Ø¹Ù† Ù…Ø¯Ù‰ Ø£Ù‡Ù…ÙŠØªÙ‡Ø§ ÙÙŠ Ø­ÙŠØ§ØªÙƒ.";
            
            addUserMessage("âœ¨ Ø§ÙƒØªØ¨ Ù„ÙŠ Ø±Ø³Ø§Ù„Ø© Ø­Ø¨ âœ¨", null);
            const loader = addLoadingIndicator();
            
            try {
                const response = await callGemini(prompt, null, null);
                loader.remove();
                addAiMessage(response);
            } catch (e) {
                loader.remove();
                addAiMessage("Ø­Ø¨ÙŠ Ù„Ùƒ Ø£ÙƒØ¨Ø± Ù…Ù† ÙƒÙ„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª.. â¤ï¸");
            }
        }

        // --- Main Submit Handler ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = userInput.value.trim();
            const hasImage = !!currentImageBase64;
            
            if (!text && !hasImage) return;

            // 1. UI Updates
            const imageSrc = hasImage ? document.getElementById('image-preview').src : null;
            addUserMessage(text, imageSrc);
            
            const tempText = text;
            const tempImage = currentImageBase64;
            const tempMime = currentImageMimeType;

            userInput.value = '';
            userInput.style.height = 'auto';
            clearImage();
            sendBtn.disabled = true;

            // 2. Loading
            const loader = addLoadingIndicator();

            // 3. Logic: Check Hardcoded -> Else Gemini
            let responseText = "";
            const cleanInput = tempText.toLowerCase().trim();

            if (!hasImage && specificAnswers[cleanInput]) {
                setTimeout(() => {
                    loader.remove();
                    addAiMessage(specificAnswers[cleanInput]);
                    sendBtn.disabled = false;
                    userInput.focus();
                }, 1000);
                return;
            }

            // 4. Call Gemini
            responseText = await callGemini(tempText || "Ø´ÙˆÙÙŠ Ù‡Ø§Ù„ØµÙˆØ±Ø© ÙŠØ§ Ø¹Ù…Ø±ÙŠ..", tempImage, tempMime);
            
            loader.remove();
            addAiMessage(responseText);
            sendBtn.disabled = false;
            userInput.focus();
        });

        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });

        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>




